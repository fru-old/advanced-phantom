<!DOCTYPE html>

<html>
<head>
  <title>old_index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="bridge.html">
                bridge.js
              </a>
            
              
              <a class="source" href="enhance.html">
                enhance.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="message.html">
                message.js
              </a>
            
              
              <a class="source" href="old_bridge.html">
                old_bridge.js
              </a>
            
              
              <a class="source" href="old_index.html">
                old_index.js
              </a>
            
              
              <a class="source" href="old_message.html">
                old_message.js
              </a>
            
              
              <a class="source" href="spawn.html">
                spawn.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>old_index.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;

<span class="hljs-keyword">var</span> http            = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">var</span> spawn 			= <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).spawn;
<span class="hljs-keyword">var</span> exec            = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).exec;
<span class="hljs-keyword">var</span> util            = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);

<span class="hljs-keyword">var</span> POLL_INTERVAL   = process.env.POLL_INTERVAL || <span class="hljs-number">500</span>;

<span class="hljs-keyword">var</span> queue = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(worker)</span> {</span>
    <span class="hljs-keyword">var</span> _q = [];
    <span class="hljs-keyword">var</span> running = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> q = {
        push: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
            _q.push(obj);
            q.process();
        },
        process: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (running || _q.length === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
            running = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">var</span> cb = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                running = <span class="hljs-literal">false</span>;
                q.process();
            }
            <span class="hljs-keyword">var</span> task = _q.shift();
            worker(task, cb);
        }
    }
    <span class="hljs-keyword">return</span> q;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callbackOrDummy</span> <span class="hljs-params">(callback, poll_func)</span> {</span>
    <span class="hljs-keyword">if</span> (!callback) <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>};
    <span class="hljs-keyword">if</span> (poll_func) {
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>console.log(“Polling for results before returning with: “ + JSON.stringify(args));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            poll_func(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>console.log(“Inside…”);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                callback.apply(<span class="hljs-literal">null</span>, args);
            });
        }
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> callback;
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unwrapArray</span> <span class="hljs-params">(arr)</span> {</span>
    <span class="hljs-keyword">return</span> arr &amp;&amp; arr.length == <span class="hljs-number">1</span> ? arr[<span class="hljs-number">0</span>] : arr
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrapArray</span><span class="hljs-params">(arr)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Ensure that arr is an Array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> (arr <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) ? arr : [arr];
}

exports.create = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback, options)</span> {</span>
    <span class="hljs-keyword">if</span> (options === <span class="hljs-literal">undefined</span>) options = {};
    <span class="hljs-keyword">if</span> (options.phantomPath === <span class="hljs-literal">undefined</span>) options.phantomPath = <span class="hljs-string">'phantomjs'</span>;
    <span class="hljs-keyword">if</span> (options.parameters === <span class="hljs-literal">undefined</span>) options.parameters = {};

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">spawnPhantom</span> <span class="hljs-params">(callback)</span> {</span>
        <span class="hljs-keyword">var</span> args=[];
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> parm <span class="hljs-keyword">in</span> options.parameters) {
            args.push(<span class="hljs-string">'--'</span> + parm + <span class="hljs-string">'='</span> + options.parameters[parm]);
        }
        args = args.concat([__dirname + <span class="hljs-string">'\\bridge.js'</span>]);

        <span class="hljs-keyword">var</span> phantom = spawn(options.phantomPath, args);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Ensure that the child process is closed when this process dies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> closeChild = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">try</span> {
                phantom.kill();
            } <span class="hljs-keyword">catch</span>(e) {}
            process.exit(<span class="hljs-number">1</span>);
        };

        <span class="hljs-keyword">var</span> uncaughtHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
            console.error(err.stack);
            closeChild();
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Note it’s possible to blow up maxEventListeners doing this - consider moving to a single handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        [<span class="hljs-string">'SIGINT'</span>, <span class="hljs-string">'SIGTERM'</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sig)</span> {</span>
            process.on(sig, closeChild);
        });

        process.on(<span class="hljs-string">'uncaughtException'</span>, uncaughtHandler);

        phantom.once(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
        	callback(err);
        });

        phantom.stderr.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
            <span class="hljs-keyword">if</span> (options.ignoreErrorPattern &amp;&amp; options.ignoreErrorPattern.exec(data)) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">return</span> console.warn(<span class="hljs-string">'phantom stderr: '</span>+data);
        });
        <span class="hljs-keyword">var</span> exitCode = <span class="hljs-number">0</span>;
        phantom.once(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(code)</span> {</span>
            [<span class="hljs-string">'SIGINT'</span>, <span class="hljs-string">'SIGTERM'</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sig)</span> {</span>
                process.removeListener(sig, closeChild);
            });
            process.removeListener(<span class="hljs-string">'uncaughtException'</span>, uncaughtHandler);
            exitCode = code;
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Wait for “Ready” line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        phantom.stdout.once(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>setup normal listener now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            phantom.stdout.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
                <span class="hljs-keyword">return</span> console.log(<span class="hljs-string">'phantom stdout: '</span>+data);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Now need to figure out what port it’s listening on - since
Phantom is busted and can’t tell us this we need to use lsof on mac, and netstat on Linux
Note that if phantom could tell you the port it ends up listening
on we wouldn’t need to do this - server.port returns 0 when you ask
for port 0 (i.e. random free port). If they ever fix that this will
become much simpler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> platform = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>).platform();
            <span class="hljs-keyword">var</span> cmd = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">switch</span> (platform) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">'linux'</span>:
                            cmd = <span class="hljs-string">'netstat -nlp | grep "[[:space:]]%d/"'</span>;
                            <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'darwin'</span>:
                            cmd = <span class="hljs-string">'lsof -p %d | grep LISTEN'</span>;
                            <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'win32'</span>:
                            cmd = <span class="hljs-string">'netstat -ano | findstr /R "\\&lt;%d\\&gt;"'</span>;
                            <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'cygwin'</span>:
                            cmd = <span class="hljs-string">'netstat -ano | grep %d'</span>;
                            <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                            phantom.kill();
                            <span class="hljs-keyword">return</span> callback(<span class="hljs-string">"Your OS is not supported yet. Tell us how to get the listening port based on PID"</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>We do this twice - first to get ports this process is listening on
and again to get ports phantom is listening on. This is to work
around this bug in libuv: <a href="https://github.com/joyent/libuv/issues/962">https://github.com/joyent/libuv/issues/962</a></p>
<ul>
<li>this is only necessary when using cluster, but it’s here regardless</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> my_pid_command = util.format(cmd, process.pid);

            exec(my_pid_command, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, stdout, stderr)</span> {</span>
                <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>This can happen if grep finds no matching lines, so ignore it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    stdout = <span class="hljs-string">''</span>;
                }
                <span class="hljs-keyword">var</span> re = <span class="hljs-regexp">/(?:127\.0\.0\.1|localhost):(\d+)/ig</span>, match;
                <span class="hljs-keyword">var</span> ports = [];
                
                <span class="hljs-keyword">while</span> (match = re.exec(stdout)) {
                    ports.push(match[<span class="hljs-number">1</span>]);
                }

                <span class="hljs-keyword">var</span> phantom_pid_command = util.format(cmd, phantom.pid);

                exec(phantom_pid_command, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, stdout, stderr)</span> {</span>
                    <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">null</span>) {
                        phantom.kill();
                        <span class="hljs-keyword">return</span> callback(<span class="hljs-string">"Error executing command to extract phantom ports: "</span> + err);
                    }
                    <span class="hljs-keyword">var</span> port;
                    <span class="hljs-keyword">while</span> (match = re.exec(stdout)) {
                        <span class="hljs-keyword">if</span> (ports.indexOf(match[<span class="hljs-number">1</span>]) == -<span class="hljs-number">1</span>) {
                            port = match[<span class="hljs-number">1</span>];
                        }
                    }

                    <span class="hljs-keyword">if</span> (!port) {
                        phantom.kill();
                        <span class="hljs-keyword">return</span> callback(<span class="hljs-string">"Error extracting port from: "</span> + stdout);
                    }

                    callback(<span class="hljs-literal">null</span>, phantom, port);
                });
            });
        });

        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>    <span class="hljs-comment">//wait a bit to see if the spawning of phantomjs immediately fails due to bad path or similar</span>
        	<span class="hljs-keyword">if</span> (exitCode !== <span class="hljs-number">0</span>) {
        		<span class="hljs-keyword">return</span> callback(<span class="hljs-string">"Phantom immediately exited with: "</span> + exitCode);
        	}
        },<span class="hljs-number">100</span>);
    };
    
    spawnPhantom(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, phantom, port)</span> {</span>
        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> callback(err);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>console.log(“Phantom spawned with web server on port: “ + port);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">var</span> pages = {};

        <span class="hljs-keyword">var</span> setup_new_page = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>console.log(“Page created with id: “ + id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> methods = [
    <span class="hljs-string">'addCookie'</span>, <span class="hljs-string">'childFramesCount'</span>, <span class="hljs-string">'clearCookies'</span>, <span class="hljs-string">'close'</span>,  
    <span class="hljs-string">'currentFrameName'</span>, <span class="hljs-string">'deleteCookie'</span>, <span class="hljs-string">'evaluateJavaScript'</span>,
    <span class="hljs-string">'childFramesName'</span>, <span class="hljs-string">'includeJs'</span>, <span class="hljs-string">'uploadFile'</span>, <span class="hljs-string">'injectJs'</span>, 
    <span class="hljs-string">'renderBase64'</span>, <span class="hljs-string">'open'</span>, <span class="hljs-string">'goBack'</span>, <span class="hljs-string">'release'</span>, <span class="hljs-string">'goForward'</span>,
    <span class="hljs-string">'reload'</span>, <span class="hljs-string">'switchToParentFrame'</span>, <span class="hljs-string">'openUrl'</span>, <span class="hljs-string">'setContent'</span>,
    <span class="hljs-string">'switchToFrame'</span>, <span class="hljs-string">'switchToChildFrame'</span>, <span class="hljs-string">'stop'</span>, <span class="hljs-string">'getPage'</span>,
    <span class="hljs-string">'switchToMainFrame'</span>, <span class="hljs-string">'switchToFocusedFrame'</span>, <span class="hljs-string">'sendEvent'</span>, 
    <span class="hljs-string">'render'</span>, <span class="hljs-string">'switchToChildFrame'</span>, <span class="hljs-string">'go'</span>, <span class="hljs-string">'evaluateAsync'</span>
];
            <span class="hljs-keyword">var</span> page = {
                setFn: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, fn, cb)</span> {</span>
                    request_queue.push([[id, <span class="hljs-string">'setFunction'</span>, name, fn.toString()], callbackOrDummy(cb, poll_func)]);
                },
                get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, cb)</span> {</span>
                    request_queue.push([[id, <span class="hljs-string">'getProperty'</span>, name], callbackOrDummy(cb, poll_func)]);
                },
                set: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, val, cb)</span> {</span>
                    request_queue.push([[id, <span class="hljs-string">'setProperty'</span>, name, val], callbackOrDummy(cb, poll_func)]);
                },
                evaluate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn, cb)</span> {</span>
                    <span class="hljs-keyword">var</span> extra_args = [];
                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">2</span>) {
                        extra_args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>console.log(“Extra args: “ + extra_args);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    }
                    request_queue.push([[id, <span class="hljs-string">'evaluate'</span>, fn.toString()].concat(extra_args), callbackOrDummy(cb, poll_func)]);
                },
                waitForSelector: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(selector, cb, timeout)</span> {</span>
                    <span class="hljs-keyword">var</span> startTime = <span class="hljs-built_in">Date</span>.now();
                    <span class="hljs-keyword">var</span> timeoutInterval = <span class="hljs-number">150</span>;
                    <span class="hljs-keyword">var</span> testRunning = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>if evaluate succeeds, invokes callback w/ true, if timeout,
invokes w/ false, otherwise just exits</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> testForSelector = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                        <span class="hljs-keyword">var</span> elapsedTime = <span class="hljs-built_in">Date</span>.now() - startTime;

                        <span class="hljs-keyword">if</span> (elapsedTime &gt; timeout) {
                            <span class="hljs-keyword">return</span> cb(<span class="hljs-string">"Timeout waiting for selector: "</span> + selector);
                        }

                        page.evaluate(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(selector)</span> {</span>
                            <span class="hljs-keyword">return</span> document.querySelectorAll(selector).length;
                        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(result)</span> {</span>
                            testRunning = <span class="hljs-literal">false</span>;
                            <span class="hljs-keyword">if</span> (result &gt; <span class="hljs-number">0</span>) {<span class="hljs-comment">//selector found</span>
                                cb();
                            }
                            <span class="hljs-keyword">else</span> {
                                setTimeout(testForSelector, timeoutInterval);
                            }
                        }, selector);
                    };

                    timeout = timeout || <span class="hljs-number">10000</span>; <span class="hljs-comment">//default timeout is 10 sec;</span>
                    setTimeout(testForSelector, timeoutInterval);
                },
            };
            methods.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(method)</span> {</span>
                page[method] = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">var</span> all_args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
                    <span class="hljs-keyword">var</span> callback = <span class="hljs-literal">null</span>;
                    <span class="hljs-keyword">if</span> (all_args.length &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">typeof</span> all_args[all_args.length - <span class="hljs-number">1</span>] === <span class="hljs-string">'function'</span>) {
                        callback = all_args.pop();
                    }
                    <span class="hljs-keyword">var</span> req_params = [id, method];
                    request_queue.push([req_params.concat(all_args), callbackOrDummy(callback, poll_func)]);
                }
            });

            pages[id] = page;

            <span class="hljs-keyword">return</span> page;            
        }

        <span class="hljs-keyword">var</span> poll_func = setup_long_poll(phantom, port, pages, setup_new_page);

        <span class="hljs-keyword">var</span> request_queue = queue(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(paramarr, next)</span> {</span>
            <span class="hljs-keyword">var</span> params = paramarr[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">var</span> callback = paramarr[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">var</span> page = params[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">var</span> method = params[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">var</span> args = params.slice(<span class="hljs-number">2</span>);
            
            <span class="hljs-keyword">var</span> http_opts = {
                hostname: <span class="hljs-string">'127.0.0.1'</span>,
                port: port,
                path: <span class="hljs-string">'/'</span>,
                method: <span class="hljs-string">'POST'</span>,
            }

            phantom.POSTING = <span class="hljs-literal">true</span>;

            <span class="hljs-keyword">var</span> req = http.request(http_opts, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(res)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>console.log(“Got a response: “ + res.statusCode);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> err = res.statusCode == <span class="hljs-number">500</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
                res.setEncoding(<span class="hljs-string">'utf8'</span>);
                <span class="hljs-keyword">var</span> data = <span class="hljs-string">''</span>;
                res.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chunk)</span> {</span>
                    data += chunk;
                });
                res.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                    phantom.POSTING = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">if</span> (!data) {
                        next();
                        <span class="hljs-keyword">return</span> callback(<span class="hljs-string">"No response body for page."</span> + method + <span class="hljs-string">"()"</span>);
                    }
                    <span class="hljs-keyword">var</span> results = <span class="hljs-built_in">JSON</span>.parse(data);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>console.log(“Response: “, results);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    
                    <span class="hljs-keyword">if</span> (err) {
                        next();
                        <span class="hljs-keyword">return</span> callback(results);
                    }

                    <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'createPage'</span>) {
                        <span class="hljs-keyword">var</span> id = results.page_id;
                        <span class="hljs-keyword">var</span> page = setup_new_page(id);
                        
                        next();
                        <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, page);
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Not createPage - just run the callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    next();
                    callback(<span class="hljs-literal">null</span>, results);
                });
            });

            req.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
                console.warn(<span class="hljs-string">"Request() error evaluating "</span> + method + <span class="hljs-string">"() call: "</span> + err);
                next();
            })

            req.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/json'</span>);

            <span class="hljs-keyword">var</span> json = <span class="hljs-built_in">JSON</span>.stringify({page: page, method: method, args: args});</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>console.log(“Sending: “, json);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            req.setHeader(<span class="hljs-string">'Content-Length'</span>, Buffer.byteLength(json));
            req.write(json);
            req.end();
        });

        <span class="hljs-keyword">var</span> proxy = {
            process: phantom,
            createPage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
                request_queue.push([[<span class="hljs-number">0</span>,<span class="hljs-string">'createPage'</span>], callbackOrDummy(callback, poll_func)]);
            },
            injectJs: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(filename,callback)</span> {</span>
                request_queue.push([[<span class="hljs-number">0</span>,<span class="hljs-string">'injectJs'</span>, filename], callbackOrDummy(callback, poll_func)]);
            },
            addCookie: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cookie, callback)</span> {</span>
                request_queue.push([[<span class="hljs-number">0</span>,<span class="hljs-string">'addCookie'</span>, cookie], callbackOrDummy(callback, poll_func)]);
            },
            clearCookies: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
                request_queue.push([[<span class="hljs-number">0</span>, <span class="hljs-string">'clearCookies'</span>], callbackOrDummy(callback, poll_func)]);
            },
            deleteCookie: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cookie, callback)</span> {</span>
                request_queue.push([[<span class="hljs-number">0</span>, <span class="hljs-string">'deleteCookie'</span>, cookie], callbackOrDummy(callback, poll_func)]);
            },
            set : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property, value, callback)</span> {</span>
                request_queue.push([[<span class="hljs-number">0</span>, <span class="hljs-string">'setProperty'</span>, property, value], callbackOrDummy(callback, poll_func)]);
            },
            get : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(property, callback)</span> {</span>
                request_queue.push([[<span class="hljs-number">0</span>, <span class="hljs-string">'getProperty'</span>, property], callbackOrDummy(callback, poll_func)]);
            },
            exit: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span>{</span>
                phantom.kill(<span class="hljs-string">'SIGTERM'</span>);
                callbackOrDummy(callback)();
            },
            on: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
                phantom.on.apply(phantom, <span class="hljs-built_in">arguments</span>);
            },
        };
        
        callback(<span class="hljs-literal">null</span>, proxy);
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setup_long_poll</span> <span class="hljs-params">(phantom, port, pages, setup_new_page)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>console.log(“Setting up long poll”);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> http_opts = {
        hostname: <span class="hljs-string">'127.0.0.1'</span>,
        port: port,
        path: <span class="hljs-string">'/'</span>,
        method: <span class="hljs-string">'GET'</span>,
    }

    <span class="hljs-keyword">var</span> dead = <span class="hljs-literal">false</span>;
    phantom.once(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span> dead = <span class="hljs-literal">true</span>; });

    <span class="hljs-keyword">var</span> poll_func = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> {</span>
        <span class="hljs-keyword">if</span> (dead) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (phantom.POSTING) <span class="hljs-keyword">return</span> cb();</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>console.log(“Polling…”);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> req = http.get(http_opts, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(res)</span> {</span>
            res.setEncoding(<span class="hljs-string">'utf8'</span>);
            <span class="hljs-keyword">var</span> data = <span class="hljs-string">''</span>;
            res.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chunk)</span> {</span>
                data += chunk;
            });
            res.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>console.log(“Poll results: “ + data);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (dead) <span class="hljs-keyword">return</span>;
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">var</span> results = <span class="hljs-built_in">JSON</span>.parse(data);
                }
                <span class="hljs-keyword">catch</span> (err) {
                    console.warn(<span class="hljs-string">"Error parsing JSON from phantom: "</span> + err);
                    console.warn(<span class="hljs-string">"Data from phantom was: "</span> + data);
                    <span class="hljs-keyword">return</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>if (results.length &gt; 0) {
    console.log(“Long poll results: “, results);
}
else {
    console.log(“Zero callbacks”);
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                results.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(r)</span> {</span>
                    <span class="hljs-keyword">if</span> (r.page_id) {
                        <span class="hljs-keyword">if</span> (pages[r.page_id] &amp;&amp; r.callback === <span class="hljs-string">'onPageCreated'</span>) {
                            <span class="hljs-keyword">var</span> new_page = setup_new_page(r.args[<span class="hljs-number">0</span>]);
                            <span class="hljs-keyword">if</span> (pages[r.page_id].onPageCreated) {
                                pages[r.page_id].onPageCreated(new_page);
                            }
                        }
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pages[r.page_id] &amp;&amp; pages[r.page_id][r.callback]) {
                            <span class="hljs-keyword">var</span> callbackFunc = pages[r.page_id][r.callback];
                            <span class="hljs-keyword">if</span> (callbackFunc.length &gt; <span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>We use <code>apply</code> if the function is expecting multiple args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                callbackFunc.apply(pages[r.page_id], wrapArray(r.args));
                            }
                            <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Old <code>call</code> behaviour is deprecated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                callbackFunc.call(pages[r.page_id], unwrapArray(r.args));
                            }
                        }
                    }
                    <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">var</span> cb = callbackOrDummy(phantom[r.callback]);
                        cb.apply(phantom, r.args);
                    }
                });
                cb();
            });
        });
        req.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
            <span class="hljs-keyword">if</span> (dead || phantom.killed) <span class="hljs-keyword">return</span>;
            console.warn(<span class="hljs-string">"Poll Request error: "</span> + err);
        });
    };

    <span class="hljs-keyword">var</span> repeater = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            poll_func(repeater)
        }, POLL_INTERVAL);
    }

    repeater();

    <span class="hljs-keyword">return</span> poll_func;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
